<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
  :root {
    --primary: #2E7D32;
    --primary-light: #66BB6A;
    --primary-dark: #1B5E20;
    --bg: radial-gradient(circle at top, #e8f5e9 0, #f1f5f2 40%, #e3f2fd 100%);
    --surface: rgba(255,255,255,0.9);
    --border: rgba(200,230,201,0.7);
    --shadow: rgba(17,24,39,0.12);
    --muted: #6b6b6b;
    --hover: rgba(102,187,106,0.08);
    --accent: #A5D6A7;
    --donate: #d32f2f;
    --donate-hover: #ef5350;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: 'Roboto', sans-serif;
    background: var(--bg);
    color: #222;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* App shell to keep content nicely centered */
  main {
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    max-width: 1120px;
    width: 100%;
    margin: 12px auto 28px;
  }

  /* TOP TABS (no horizontal scroll) */
  .tabs {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    background: rgba(255,255,255,0.92);
    border-bottom: 1px solid var(--border);
    box-shadow: 0 2px 18px var(--shadow);
    position: sticky;
    top: 0;
    z-index: 10;
    overflow: hidden;
    user-select: none;
    backdrop-filter: blur(14px);
  }

  .tab {
    position: relative;
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    border-radius: 999px;
    cursor: pointer;
    font-weight: 600;
    color: var(--primary-dark);
    border: 1px solid transparent;
    transition: background .18s ease, color .18s ease, box-shadow .18s ease, transform .12s ease;
    white-space: nowrap;
    max-width: 100%;
  }

  .tab:hover {
    background: var(--hover);
  }

  .tab.active {
    background: var(--primary-light);
    color: #fff;
    box-shadow: 0 4px 10px rgba(0,0,0,0.08);
  }

  .tab.active::after {
    content: "";
    position: absolute;
    left: 16px;
    right: 16px;
    bottom: -5px;
    height: 3px;
    border-radius: 999px;
    background: rgba(38, 166, 91, 0.9);
  }

  .tab .material-icons {
    font-size: 18px;
    flex: 0 0 auto;
  }

  .tab .label {
    font-size: 13px;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* "More" tab */
  .tab.more {
    margin-left: auto;
    position: relative;
    display: none;
  }

  /* MAIN CARDS */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 18px;
    padding: 16px 18px;
    box-shadow: 0 10px 30px var(--shadow);
    backdrop-filter: blur(16px);
  }

  .title-with-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }

  .version-badge {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    padding: 3px 8px;
    border-radius: 999px;
    border: 1px solid rgba(27,94,32,0.18);
    background: rgba(232,245,233,0.95);
    color: var(--primary-dark);
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    white-space: nowrap;
  }

  /* More panel in main content */
  .more-panel {
    display: none;
  }

  .more-panel-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
  }

  .more-panel-header h2 {
    margin: 0;
  }

  .more-panel-description {
    color: var(--muted);
    font-size: 12px;
    margin-bottom: 10px;
  }

  .more-panel-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }

  h1 {
    font-size: 20px;
    font-weight: 800;
    color: var(--primary-dark);
    letter-spacing: 0.01em;
  }

  h2 {
    font-size: 16px;
    font-weight: 700;
    color: var(--primary-dark);
  }

  label {
    display: block;
    font-weight: 600;
    color: var(--primary-dark);
    margin-bottom: 6px;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  input,
  select,
  textarea {
    width: 100%;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: #fff;
    font-size: 13px;
    margin-bottom: 10px;
    transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
    font-family: inherit;
    resize: vertical;
  }

  input:focus,
  select:focus,
  textarea:focus {
    outline: none;
    border-color: var(--primary-light);
    box-shadow: 0 0 0 2px rgba(102,187,106,0.35);
    background: #fcfffc;
  }

  .row {
    display: flex;
    flex-wrap: wrap;
    gap: 10px 14px;
  }

  .row > * {
    flex: 1;
    min-width: 220px;
  }

  /* BUTTONS */
  .btn {
    background: var(--primary);
    color: #fff;
    padding: 9px 13px;
    border-radius: 999px;
    border: none;
    font-weight: 600;
    cursor: pointer;
    font-size: 13px;
    letter-spacing: 0.03em;
    text-transform: uppercase;
    transition: background .18s ease, transform .1s ease, box-shadow .18s ease;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.18);
    text-decoration: none;
  }

  .btn .material-icons {
    font-size: 18px;
  }

  .btn:hover {
    background: var(--primary-light);
    transform: translateY(-1px);
    box-shadow: 0 7px 18px rgba(0,0,0,0.22);
  }

  .btn:active {
    transform: translateY(0);
    box-shadow: 0 3px 10px rgba(0,0,0,0.18);
  }

  .btn.secondary {
    background: #fff;
    color: var(--primary);
    border: 1px solid var(--border);
    box-shadow: 0 2px 8px rgba(0,0,0,0.10);
  }

  .btn.secondary:hover {
    background: rgba(245,250,245,0.95);
  }

  .btn.donate {
    background: var(--donate);
  }

  .btn.donate:hover {
    background: var(--donate-hover);
  }

  /* Focus states for clickable elements */
  .btn:focus-visible,
  .tab:focus-visible,
  .chip:focus-visible {
    outline: 2px solid #1b5e20;
    outline-offset: 2px;
  }

  /* NOTIFICATION TOAST */
  #notification {
    position: fixed;
    right: 20px;
    bottom: 16px;
    min-width: 260px;
    max-width: 360px;
    display: none;
    padding: 10px 12px;
    border-radius: 12px;
    font-weight: 600;
    box-shadow: 0 10px 26px rgba(0,0,0,0.2);
    font-size: 13px;
    z-index: 50;
  }

  #notification.success {
    background: #E8F5E9;
    color: var(--primary-dark);
    border: 1px solid #C8E6C9;
  }

  #notification.error {
    background: #FFEBEE;
    color: #C62828;
    border: 1px solid #FFCDD2;
  }

  /* Audition quick chips */
  .chipbar {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .chip {
    background: #fff;
    color: var(--primary-dark);
    border: 1px solid var(--border);
    padding: 7px 12px;
    border-radius: 999px;
    font-weight: 600;
    cursor: pointer;
    transition: background .18s ease, color .18s ease, border-color .18s ease, box-shadow .18s ease;
    user-select: none;
    flex: 0 0 auto;
    font-size: 12px;
  }

  .chip:hover {
    background: var(--hover);
  }

  .chip.active {
    background: var(--primary-light);
    color: #fff;
    border-color: transparent;
    box-shadow: 0 4px 10px rgba(0,0,0,0.12);
  }

  @media (max-width: 420px) {
    .tab .label {
      display: none;
    }
  }

  /* METRICS / KPIs */
  .metrics {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }

  .kpi {
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 12px 14px;
    flex: 1 1 160px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  }

  .kpi .label {
    font-size: 12px;
    color: var(--muted);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
  }

  .kpi .value {
    font-size: 22px;
    font-weight: 800;
    color: var(--primary-dark);
    line-height: 1.2;
    margin-top: 4px;
  }

  .kpi .sub {
    font-size: 11px;
    color: var(--muted);
    margin-top: 4px;
  }

  /* TABLES (Insights Recent Activity) */
  .table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  .table thead {
    background: rgba(232,245,233,0.9);
  }

  .table th,
  .table td {
    text-align: left;
    padding: 8px 10px;
    border-bottom: 1px solid var(--border);
  }

  .table tbody tr:nth-child(odd) {
    background: rgba(250,252,250,0.9);
  }

  .table tbody tr:hover {
    background: rgba(230,244,234,0.7);
  }

  .subtitle {
    color: var(--muted);
    font-size: 12px;
    margin-top: 4px;
   }
  </style>
</head>
<body>

  <!-- Top Tabs -->
  <div class="tabs" id="tabstrip" role="tablist" aria-label="Voice Tracker Sections">
    <div class="tab active" data-section="dashboard" role="tab" aria-selected="true" title="Dashboard">
      <span class="material-icons">home</span><span class="label">Dashboard</span>
    </div>
    <div class="tab" data-section="updates" role="tab" title="Updates">
      <span class="material-icons">build</span><span class="label">Updates</span>
    </div>
    <div class="tab" data-section="search" role="tab" title="Search">
      <span class="material-icons">search</span><span class="label">Search</span>
    </div>
    <div class="tab" data-section="insights" role="tab" title="Insights">
      <span class="material-icons">insights</span><span class="label">Insights</span>
    </div>
    <div class="tab" data-section="auditions" role="tab" title="Auditions">
      <span class="material-icons">headset</span><span class="label">Auditions</span>
    </div>

    <!-- NEW: Settings tab -->
    <div class="tab" data-section="settings" role="tab" title="Settings">
      <span class="material-icons">settings</span><span class="label">Settings</span>
    </div>

    <div class="tab" data-section="actions" role="tab" title="Actions">
      <span class="material-icons">download</span><span class="label">Actions</span>
    </div>

    <!-- More (auto appears if needed) -->
    <div class="tab more" id="moreTab" title="More">
      <span class="material-icons">more_horiz</span><span class="label">More</span>
    </div>
  </div>

  <main>
    <!-- More panel in main content -->
    <div id="morePanel" class="card more-panel">
      <div class="more-panel-header">
        <span class="material-icons">view_comfy</span>
        <h2>More Features</h2>
      </div>
      <div class="more-panel-description">
        These sections are hidden from the top bar on smaller screens. Pick one to jump straight there.
      </div>
      <div id="morePanelBody" class="more-panel-buttons"></div>
    </div>

    <!-- Title row -->
    <div class="card">
      <div class="row" style="align-items:center;">
        <h1 class="title-with-badge">
         üéôÔ∏è Voice Project Tracker
         <span class="version-badge">v1.0</span>
        </h1>
        <div style="flex:1"></div>

        <!-- Donate button -->
        <a class="btn donate"
           href="https://gofund.me/64825f604"
           target="_blank"
           rel="noopener"
           aria-label="Donate (opens in a new tab)"
           title="Donate">
          <span class="material-icons">volunteer_activism</span>
          Donate
        </a>

        <button class="btn secondary" type="button" onclick="refreshSheet()">
          <span class="material-icons">refresh</span> Refresh Sheet
        </button>
        <button class="btn" type="button" onclick="exportPDF()">
          <span class="material-icons">picture_as_pdf</span> Export PDF
        </button>
      </div>
      <div style="color:var(--muted); font-size:12px; margin-top:4px;">Use the tabs to navigate. All operations run via Apps Script.</div>
    </div>

    <section id="dashboard" class="card" role="region">
      <div class="row">
        <button class="btn" type="button" onclick="quickFilter('Current')">Current</button>
        <button class="btn secondary" type="button" onclick="quickFilter('Past')">Past</button>
        <button class="btn secondary" type="button" onclick="quickFilter('All')">All</button>
      </div>
    </section>

    <section id="updates" class="card" style="display:none;">
      <div class="row">
        <div>
          <label for="character">Character</label>
          <select id="character"></select>
        </div>
        <div>
          <label for="fileUrl">Specific File URL (optional)</label>
          <input id="fileUrl" placeholder="Paste a File Link URL (optional)">
        </div>
      </div>
      <div class="row">
        <div>
          <label for="link">Final Production Link</label>
          <input id="link" placeholder="https://...">
        </div>
        <div>
          <label for="status">Status</label>
          <select id="status"><option>Current</option><option>Past</option></select>
        </div>
      </div>
      <button class="btn" type="button" onclick="applySingle()">Apply Update</button>

      <hr style="margin:14px 0;border:none;border-top:1px solid var(--border);">

      <div class="row">
        <div>
          <label for="bulkCharacters">Bulk Characters</label>
          <select id="bulkCharacters" multiple></select>
        </div>
        <div>
          <label for="bulkFiles">Bulk Files (optional)</label>
          <select id="bulkFiles" multiple></select>
        </div>
      </div>
      <div class="row">
        <div>
          <label for="bulkLink">Bulk Final Link</label>
          <input id="bulkLink" placeholder="https://...">
        </div>
        <div>
          <label for="bulkStatus">Bulk Status</label>
          <select id="bulkStatus">
            <option value="">-- No change --</option>
            <option>Current</option>
            <option>Past</option>
          </select>
        </div>
      </div>
      <button class="btn" type="button" onclick="applyBulk()">Apply Bulk Changes</button>
    </section>

    <section id="search" class="card" style="display:none;">
      <div class="row">
        <div><label for="searchCharacter">Search by Character</label><input id="searchCharacter"></div>
        <div><label for="searchFolder">Search by Folder</label><input id="searchFolder"></div>
        <div><label for="searchFile">Search by File Name</label><input id="searchFile"></div>
        <div>
          <label for="statusFilter">Filter by Status</label>
          <select id="statusFilter"><option>All</option><option>Current</option><option>Past</option></select>
        </div>
      </div>
      <div class="row">
        <button class="btn" type="button" onclick="searchProjects()">Search</button>
        <button class="btn secondary" type="button" onclick="applyStatusFilter()">Filter</button>
      </div>
    </section>

    <section id="insights" class="card" style="display:none;">
      <div class="row" style="align-items:center;">
        <h1 style="margin:0;">üìà Insights</h1>
        <div style="flex:1"></div>
        <button class="btn secondary" type="button" onclick="loadInsights()"><span class="material-icons">refresh</span> Refresh</button>
      </div>

      <!-- KPI grid -->
      <div id="insightsKpis" class="metrics" style="margin-top:10px;"></div>

      <!-- Recent activity -->
      <div class="card" style="margin-top:12px;">
        <div class="row" style="align-items:center;">
          <h2 style="font-size:16px; margin:0;">Recent Activity</h2>
          <div style="flex:1"></div>
          <small style="color:var(--muted)">Latest additions across Voice & Auditions</small>
        </div>
        <div style="overflow:auto; margin-top:8px;">
          <table class="table" id="insightsRecentTable" style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th style="text-align:left; padding:8px; border-bottom:1px solid var(--border);">When</th>
                <th style="text-align:left; padding:8px; border-bottom:1px solid var(--border);">Type</th>
                <th style="text-align:left; padding:8px; border-bottom:1px solid var(--border);">Character</th>
                <th style="text-align:left; padding:8px; border-bottom:1px solid var(--border);">File</th>
                <th style="text-align:left; padding:8px; border-bottom:1px solid var(--border);">Status</th>
              </tr>
            </thead>
            <tbody id="insightsRecentBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="auditions" class="card" style="display:none;">
      <div class="row" style="align-items:center;">
        <div class="chipbar">
          <button class="chip active"   data-aud="All"       type="button" onclick="quickAudition('All', this)">All</button>
          <button class="chip"          data-aud="Pending"   type="button" onclick="quickAudition('Pending', this)">Pending</button>
          <button class="chip"          data-aud="Submitted" type="button" onclick="quickAudition('Submitted', this)">Submitted</button>
          <button class="chip"          data-aud="Booked"    type="button" onclick="quickAudition('Booked', this)">Booked</button>
          <button class="chip"          data-aud="Passed"    type="button" onclick="quickAudition('Passed', this)">Passed</button>
        </div>
        <div style="flex:1"></div>
        <button class="btn secondary" type="button" onclick="syncNow()"><span class="material-icons">sync</span> Sync Status</button>
        <button class="btn" type="button" onclick="refreshAuditions()"><span class="material-icons">refresh</span> Refresh</button>
      </div>

      <!-- Quick search row -->
      <div class="row" style="margin-top:10px; align-items:flex-end; gap:8px;">
        <div style="flex:1;">
          <label for="auditionSearch">Quick search (character / file / folder)</label>
          <input id="auditionSearch" placeholder="Type and press Enter or click Search">
        </div>
        <button class="btn" type="button" onclick="doAuditionSearch()">Search</button>
        <button class="btn secondary" type="button" onclick="clearAuditionSearch()">Clear</button>
      </div>
    </section>

    <!-- NEW: Settings section -->
    <section id="settings" class="card" style="display:none;">
      <div class="row" style="align-items:flex-start;">
        <div style="flex:1 1 260px; min-width:260px;">
          <h2 style="margin-bottom:6px;">Settings</h2>
          <div class="subtitle">
            Configure the core folders used by the Voice Project Tracker.  
            Paste just the <strong>folder ID</strong> (the long string from your Drive URL).
          </div>

          <div style="margin-top:12px;">
            <label for="settingsVoiceFolderId">Voice Folder ID</label>
            <input id="settingsVoiceFolderId" placeholder="e.g. 1lq_rbzqRj_keQ3XXwtWUYG7z6hNGTxK7">

            <label for="settingsAuditionFolderId">Audition Folder ID</label>
            <input id="settingsAuditionFolderId" placeholder="e.g. 1YtKGcqfCC3zR5XriayoMw-SpvmA2Exmk">
          </div>

          <div style="margin-top:8px;">
            <button class="btn" type="button" onclick="saveSettings()">
              <span class="material-icons">save</span> Save Settings
            </button>
            <button class="btn secondary" type="button" onclick="loadSettings()">
              <span class="material-icons">refresh</span> Reload
            </button>
          </div>
        </div>

        <div style="flex:1 1 260px; min-width:260px;">
          <label for="settingsNotes">Notes / Future Settings</label>
          <textarea id="settingsNotes" rows="5" placeholder="Optional notes about your setup, alternate folders, or future ideas. (Not used by the script yet.)"></textarea>
        </div>
      </div>
    </section>

    <section id="actions" class="card" style="display:none;">
      <div class="row">
        <button class="btn" type="button" onclick="refreshSheet()">Refresh Voice Sheet</button>
        <button class="btn secondary" type="button" onclick="exportPDF()">Export Summary PDF</button>
      </div>
    </section>

    <div id="notification"></div>
  </main>

  <script>
    /* ===== Safety shim for google.script.run (prevents crashes if opened outside GAS) ===== */
    (function(){
      const hasGAS = (typeof google !== 'undefined') && google.script && google.script.run;
      if (!hasGAS) {
        const fakeRun = new Proxy({
          withSuccessHandler(){ return fakeRun; },
          withFailureHandler(){ return fakeRun; }
        }, {
          get(target, prop){
            if (prop === 'withSuccessHandler' || prop === 'withFailureHandler') return target[prop];
            return function(){ console.warn('[Demo] No Apps Script context for:', prop); return fakeRun; };
          }
        });
        window.google = window.google || {};
        window.google.script = window.google.script || {};
        window.google.script.run = fakeRun;
        window.addEventListener('load', () => {
          const n = document.getElementById('notification');
          if (n) { n.textContent = 'Running without Apps Script server ‚Äî actions are in demo mode.'; n.className='success'; n.style.display='block'; setTimeout(()=>n.style.display='none', 3000); }
        });
      }
    })();

    // ===== Tabs + Overflow to "More" =====
    const tabstrip = document.getElementById('tabstrip');
    const allTabs = Array.from(tabstrip.querySelectorAll('.tab:not(.more)'));
    const moreTab = document.getElementById('moreTab');
    const morePanel = document.getElementById('morePanel');
    const morePanelBody = document.getElementById('morePanelBody');

    function activateSection(id){
      document.querySelectorAll('main section').forEach(s => {
        s.style.display = (s.id === id ? 'block' : 'none');
      });
      allTabs.forEach(t => {
        t.classList.toggle('active', t.dataset.section === id);
        t.setAttribute('aria-selected', t.dataset.section === id ? 'true' : 'false');
      });
      if (morePanel) morePanel.style.display = 'none';

      if (id === 'insights') loadInsights();
      if (id === 'settings') loadSettings();
    }

    allTabs.forEach(t => t.addEventListener('click', () => activateSection(t.dataset.section)));

    function layoutTabs(){
      // Reset
      allTabs.forEach(t => t.style.display = 'flex');
      if (morePanelBody) morePanelBody.innerHTML = '';
      if (morePanel) morePanel.style.display = 'none';
      moreTab.style.display = 'none';

      const available = tabstrip.clientWidth - 10; // buffer
      let used = 0;
      const hiddenTabs = [];

      for (const t of allTabs) {
        used += t.offsetWidth + 6;
        if (used > available) {
          hiddenTabs.push(t);
          t.style.display = 'none';
          moreTab.style.display = 'flex';
        }
      }

      if (hiddenTabs.length && morePanelBody) {
        hiddenTabs.forEach(t => {
          const label = t.querySelector('.label')?.textContent || t.title || t.dataset.section;
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'btn secondary';
          btn.textContent = label;
          btn.addEventListener('click', () => {
            activateSection(t.dataset.section);
            if (morePanel) morePanel.style.display = 'none';
          });
          morePanelBody.appendChild(btn);
        });
      }
    }

    moreTab.addEventListener('click', (e) => {
      e.stopPropagation();
      if (!morePanel) return;
      morePanel.style.display = (morePanel.style.display === 'none' || morePanel.style.display === '' ? 'block' : 'none');
    });

    document.addEventListener('click', (e) => {
      if (!morePanel) return;
      if (!morePanel.contains(e.target) && !moreTab.contains(e.target)) {
        morePanel.style.display = 'none';
      }
    });

    window.addEventListener('load', layoutTabs);
    window.addEventListener('resize', layoutTabs);

    // ===== Data bootstrapping (guard optional elements) =====
    google.script.run.withSuccessHandler(function(chars){
      ['character','bulkCharacters','countCharacter'].forEach(id=>{
        const sel = document.getElementById(id);
        if (!sel) return; // counts UI may not exist
        sel.innerHTML = '';
        (chars || []).forEach(c=>{
          const opt=document.createElement('option'); opt.value=c; opt.text=c; sel.appendChild(opt);
        });
      });
      const countSelect = document.getElementById('countCharacter');
      if (countSelect) updateCounts();
    }).getCharacters?.();

    const bulkCharsEl = document.getElementById('bulkCharacters');
    if (bulkCharsEl) {
      bulkCharsEl.addEventListener('change', function(){
        var selectedChars = Array.from(this.selectedOptions).map(o=>o.value);
        google.script.run.withSuccessHandler(function(files){
          const fileSel = document.getElementById('bulkFiles'); if (!fileSel) return;
          fileSel.innerHTML='';
          (files || []).forEach(f=>{
            const opt=document.createElement('option'); opt.value=f.url; opt.text=f.fileName; fileSel.appendChild(opt);
          });
        }).getFilesByCharacters?.(selectedChars);
      });
    }

    function showNotification(msg,type){
      const n=document.getElementById('notification');
      n.textContent=msg; n.className=type; n.style.display='block';
      setTimeout(()=>n.style.display='none',3000);
    }

    // ===== Settings load/save =====
    function loadSettings(){
      const voiceInput = document.getElementById('settingsVoiceFolderId');
      const audInput   = document.getElementById('settingsAuditionFolderId');
      if (!voiceInput || !audInput) return;

      google.script.run
        .withSuccessHandler(function(cfg){
          cfg = cfg || {};
          voiceInput.value = cfg.voiceFolderId || '';
          audInput.value   = cfg.auditionFolderId || '';
        })
        .withFailureHandler(function(err){
          showNotification(err && err.message ? err.message : 'Failed to load settings', 'error');
        })
        .getTrackerSettings?.();
    }

    function saveSettings(){
      const voiceInput = document.getElementById('settingsVoiceFolderId');
      const audInput   = document.getElementById('settingsAuditionFolderId');
      if (!voiceInput || !audInput) return;

      const payload = {
        voiceFolderId: (voiceInput.value || '').trim(),
        auditionFolderId: (audInput.value || '').trim()
      };

      google.script.run
        .withSuccessHandler(function(){
          showNotification('Settings saved.', 'success');
        })
        .withFailureHandler(function(err){
          showNotification(err && err.message ? err.message : 'Failed to save settings', 'error');
        })
        .saveTrackerSettings?.(payload);
    }

    // ===== Updates / Bulk =====
    function applySingle(){
      const charName=document.getElementById('character')?.value || '';
      const fileUrl=document.getElementById('fileUrl')?.value || '';
      const link=document.getElementById('link')?.value || '';
      const status=document.getElementById('status')?.value || '';
      if(!charName) return showNotification("Select a character.","error");
      google.script.run
        .withSuccessHandler(count => showNotification("Updated "+count+" row(s).","success"))
        .withFailureHandler(err => showNotification(err?.message || "Update failed","error"))
        .applyLinkAndStatusForCharacter?.(charName,fileUrl,link,status);
    }

    function applyBulk(){
      const chars=Array.from(document.getElementById('bulkCharacters')?.selectedOptions || []).map(o=>o.value);
      const files=Array.from(document.getElementById('bulkFiles')?.selectedOptions || []).map(o=>o.value);
      const status=document.getElementById('bulkStatus')?.value || '';
      const link=document.getElementById('bulkLink')?.value || '';
      if(chars.length===0) return showNotification("Select at least one character.","error");
      google.script.run
        .withSuccessHandler(count => showNotification("Bulk update applied to "+count+" row(s).","success"))
        .withFailureHandler(err => showNotification(err?.message || "Bulk update failed","error"))
        .applyBulkLinkAndStatus?.(chars,files,link,status);
    }

    function loadInsights(){
      google.script.run
        .withSuccessHandler(renderInsights)
        .withFailureHandler(e => showNotification('Failed to load insights: ' + (e?.message || e), 'error'))
        .getStatsAndRecent?.();
    }

    function renderInsights(d){
      try {
        const kpis = [
          { label: 'Voice ‚Äî Total',         value: d?.voice?.total },
          { label: 'Voice ‚Äî Current',       value: d?.voice?.current,  sub: `Past: ${d?.voice?.past}` },
          { label: 'Voice ‚Äî Added (7d)',    value: d?.voice?.recent7,  sub: `30d: ${d?.voice?.recent30}` },
          { label: 'Auditions ‚Äî Total',     value: d?.auditions?.total },
          { label: 'Auditions ‚Äî Pending',   value: d?.auditions?.pending,  sub: `Submitted: ${d?.auditions?.submitted}` },
          { label: 'Auditions ‚Äî Booked',    value: d?.auditions?.booked,    sub: `Passed: ${d?.auditions?.passed}` },
          { label: 'Auditions ‚Äî Added (7d)',value: d?.auditions?.recent7,   sub: `30d: ${d?.auditions?.recent30}` }
        ];

        const kpiWrap = document.getElementById('insightsKpis');
        kpiWrap.innerHTML = '';
        kpis.forEach(k => {
          const box = document.createElement('div');
          box.className = 'kpi';
          box.innerHTML = `
            <div class="label">${escapeHtml(k.label)}</div>
            <div class="value">${numberFormat(k.value)}</div>
            ${k.sub ? `<div class="sub">${escapeHtml(k.sub)}</div>` : ''}
          `;
          kpiWrap.appendChild(box);
        });

        const body = document.getElementById('insightsRecentBody');
        body.innerHTML = '';
        (d?.recent || []).forEach(r => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td style="padding:8px; border-bottom:1px solid var(--border);">${fmtDate(r.date)}</td>
            <td style="padding:8px; border-bottom:1px solid var(--border);">${escapeHtml(r.type)}</td>
            <td style="padding:8px; border-bottom:1px solid var(--border);">${escapeHtml(r.character || '')}</td>
            <td style="padding:8px; border-bottom:1px solid var(--border);">${escapeHtml(r.fileName || '')}</td>
            <td style="padding:8px; border-bottom:1px solid var(--border);">${escapeHtml(r.status || '')}</td>
          `;
          body.appendChild(tr);
        });

      } catch(e){
        showNotification('Failed to render insights: ' + e, 'error');
      }
    }

    function numberFormat(n){ n = Number(n||0); return n.toLocaleString(); }
    function fmtDate(iso){
      if (!iso) return '-';
      const d = new Date(iso);
      if (String(d) === 'Invalid Date') return '-';
      return d.toLocaleDateString(undefined, {year:'numeric', month:'short', day:'numeric'});
    }
    function escapeHtml(s){
      return String(s==null?'':s)
        .replace(/&/g,'&amp;').replace(/</g,'&lt;')
        .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
    }

    // ===== Voice Projects quick filter =====
    function quickFilter(status){
      const sel = document.getElementById('statusFilter');
      if (sel) sel.value = status;
      google.script.run
        .withSuccessHandler(() => showNotification(`Filtered: ${status || 'All'}`, 'success'))
        .withFailureHandler(err => showNotification(`Filter error: ${err && err.message ? err.message : err}`, 'error'))
        .filterByStatus?.(status);
    }
    function searchProjects(){
      const c = document.getElementById('searchCharacter')?.value || '';
      const f = document.getElementById('searchFolder')?.value || '';
      const fn= document.getElementById('searchFile')?.value || '';
      google.script.run.searchVoiceProjects?.(c,f,fn);
    }
    function applyStatusFilter(){
      const status=document.getElementById('statusFilter')?.value || 'All';
      google.script.run.filterByStatus?.(status);
    }

    // ===== Auditions: status chips + quick search =====
    function currentAuditionStatus(){
      const active = document.querySelector('.chipbar .chip.active');
      return active ? active.getAttribute('data-aud') : 'All';
    }
    function doAuditionSearch(){
      const q = (document.getElementById('auditionSearch')?.value || '').trim();
      const status = currentAuditionStatus();
      google.script.run.filterAuditionStatus?.(status, q);
    }
    function clearAuditionSearch(){
      const input = document.getElementById('auditionSearch');
      if (input) input.value = '';
      doAuditionSearch();
    }
    function quickAudition(status, el){
      document.querySelectorAll('.chipbar .chip').forEach(c => c.classList.remove('active'));
      if (el) el.classList.add('active');
      doAuditionSearch();
    }
    document.addEventListener('keydown', function(e){
      if (e.key === 'Enter' && (e.target || {}).id === 'auditionSearch') {
        doAuditionSearch();
      }
    });

    // ===== Counts (optional UI) =====
    function updateCounts(){
      const sel = document.getElementById('countCharacter');
      if(!sel) return;
      const charName = sel.value || '';
      google.script.run.withSuccessHandler(function(counts){
        const p=document.getElementById('charCounts');
        if (!p) return;
        if(!counts || !counts[charName]) p.textContent="Total Files: 0 | Files with Final Link: 0";
        else { const c=counts[charName]; p.textContent="Total Files: "+c.total+" | Files with Final Link: "+c.duplicates; }
      }).getCharacterCounts?.();
    }
    const countSel = document.getElementById('countCharacter');
    if (countSel) countSel.addEventListener('change', updateCounts);

    // ===== Auditions refresh + sync =====
    function refreshAuditions(){
      google.script.run.withSuccessHandler(()=>{
        showNotification("Auditions refreshed!","success");
        doAuditionSearch(); // reapply active chip + query
      }).updateAuditions?.();
    }
    function syncNow(){
      google.script.run.withSuccessHandler(function(res){
        const b = (res && res.booked) || 0;
        const s = (res && res.submitted) || 0;
        showNotification(`Synced: ${b} ‚Üí Booked, ${s} ‚Üí Submitted`, 'success');
        doAuditionSearch();
      }).syncNow?.();
    }

    // ===== Voice sheet actions =====
    function refreshSheet(){
      google.script.run.withSuccessHandler(()=>showNotification("Voice sheet refreshed!","success")).updateVoiceProjects?.();
    }
    function exportPDF(){
      google.script.run.withSuccessHandler(name=>showNotification("PDF exported: "+name,"success")).exportSummaryPDF?.();
    }

    // Default: All + empty search for auditions
    window.addEventListener('load', () =>
      quickAudition('All', document.querySelector('.chipbar .chip[data-aud="All"]'))
    );
  </script>
</body>
</html>
